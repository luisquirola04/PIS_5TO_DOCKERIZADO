name: 01 - Secure Main Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: read
  checks: write
  pull-requests: write
  security-events: write
  packages: write
  id-token: write

jobs:
  # 1️⃣ Seguridad primero (Gitleaks)
  pre-flight-security:
    name: Pre-flight Security
    uses: ./.github/workflows/00-security-preflight.yml

  # 2️⃣ Build Docker Compose
  build:
    name: Build Docker Compose
    needs: pre-flight-security
    uses: ./.github/workflows/build.yml

  # 3️⃣ Build, Push & Sign Docker Image
  docker-build-sign:
    name: Build & Sign Docker Image
    needs: build
    uses: ./.github/workflows/docker.yml
    permissions:
      contents: read
      packages: write
      id-token: write

  # 4️⃣ Scan de vulnerabilidades (Trivy)
  container-scan:
    name: Container Image Scan
    needs: docker-build-sign
    uses: ./.github/workflows/container-image-scan.yml
    with:
      # ✅ CORREGIDO: Usamos .outputs.image (no image-tag)
      image-tag: ${{ needs.docker-build-sign.outputs.image }}
    permissions:
      security-events: write

  # 5️⃣ DAST (OWASP ZAP)
  dast:
    name: DAST Scan
    # ✅ CORREGIDO: Añadimos 'docker-build-sign' a needs para poder leer sus outputs
    needs: [container-scan, docker-build-sign]
    uses: ./.github/workflows/dast.yml
    with:
      # ✅ CORREGIDO: Usamos .outputs.image
      image-tag: ${{ needs.docker-build-sign.outputs.image }}
